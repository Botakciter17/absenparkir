<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload - Absensi Piket</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:#fef9e7;font-family:'Roboto',sans-serif;
      background-image:
        repeating-linear-gradient(0deg,transparent,transparent 31px,#e8dcc4 31px,#e8dcc4 32px),
        repeating-linear-gradient(90deg,transparent,transparent 31px,#e8dcc4 31px,#e8dcc4 32px);
      min-height:100vh
    }
    nav{background:#fff;border-bottom:3px solid #333;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:3px 3px 0 rgba(0,0,0,.1);flex-wrap:wrap;gap:10px}
    .navbar-brand{font-size:clamp(18px,4vw,24px);color:#e74c3c;font-weight:bold}
    .btn{padding:8px 20px;border:3px solid #333;background:#fff;cursor:pointer;font-size:16px;font-weight:bold;transition:.2s;text-decoration:none;color:#333;display:inline-block}
    .btn:hover{transform:translate(-2px,-2px);box-shadow:3px 3px 0 #333}
    .btn-outline-secondary{background:#ecf0f1}
    .btn-success{background:#2ecc71;color:#fff}
    .container{max-width:1200px;margin:20px auto;padding:0 15px}
    .alert{padding:15px;margin-bottom:20px;border:3px solid #333;background:#fff9c4;font-size:16px;box-shadow:4px 4px 0 rgba(0,0,0,.1);border-radius:5px}
    .card{background:#fff;border:3px solid #333;padding:20px;margin-bottom:25px;box-shadow:5px 5px 0 rgba(0,0,0,.1);border-radius:10px}
    h5{font-size:clamp(20px,4vw,26px);color:#e74c3c;margin-bottom:20px;font-weight:bold}
    .form-control{padding:12px;border:3px solid #333;background:#fff;font-size:16px;width:100%;margin-bottom:10px;border-radius:5px}
    .form-control:focus{outline:none;background:#fffacd;border-color:#3498db}
    .upload-info{padding:10px;background:#e8f4f8;border-left:4px solid #3498db;margin-bottom:15px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
    th{background:#3498db;color:#fff;padding:12px 8px;text-align:left;border:2px solid #333;font-weight:bold}
    td{padding:10px 8px;border:2px solid #ddd;background:#fff;word-break:break-word}
    tr:nth-child(even) td{background:#f8f9fa}
    .badge{display:inline-block;padding:5px 10px;border:2px solid #333;font-weight:bold;font-size:12px;border-radius:4px;white-space:nowrap}
    .badge-hadir{background:#17a2b8;color:#fff}
    .badge-izin{background:#ffc107;color:#333}
    .bg-success{background:#2ecc71;color:#fff}
    .bg-warning{background:#f39c12;color:#333}
    .bg-danger{background:#e74c3c;color:#fff}
    .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .submit-btn-container{margin-top:15px}
  </style>
</head>
<body>
<nav>
  <span class="navbar-brand">üëã Halo, {{ username | upper }}</span>
  <div>
    <a class="btn btn-outline-secondary" href="/logout">Logout</a>
  </div>
</nav>

<div class="container">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card">
    <h5>üì∏ Upload Absensi Hadir</h5>
    <div class="upload-info">
      üìä Upload hari ini: <strong>{{ upload_count }}/{{ max_upload }}</strong> | 
      Sisa: <strong>{{ remaining }}</strong> kali
    </div>

    <div style="margin-bottom:12px;">
      <a class="btn btn-outline-secondary" href="/izin">üìù Ajukan Izin (pindah ke halaman izin)</a>
    </div>

    <form method="post" action="/upload" enctype="multipart/form-data">
      <input type="hidden" name="jenis" value="hadir">

      <div class="form-group">
        <label>‚è∞ Jam Datang *</label>
        <input class="form-control" type="time" name="jam_datang" required>
        <small style="color:#666;font-size:12px;">Wajib diisi. Contoh: 06:15</small>
      </div>

      <div class="form-group">
        <label>üì∑ Pilih Foto</label>
        <input class="form-control" type="file" name="file" accept="image/*" required 
               {% if remaining <= 0 %}disabled{% endif %}>
        <small style="color:#666;font-size:12px;">‚ÑπÔ∏è Foto harus diambil jam 06:00-06:59 atau di lokasi sekolah</small>
      </div>

      <div class="submit-btn-container">
        <button class="btn btn-success" type="submit" style="width:100%;" {% if remaining <= 0 %}disabled{% endif %}>
          Upload Absensi Hadir
        </button>
      </div>
    </form>

    <p style="margin-top:15px;font-size:13px;color:#666;text-align:center;">
      ‚ÑπÔ∏è File: JPG, PNG, GIF, BMP, WEBP (Max 10MB)
    </p>
  </div>

  <div class="card">
    <h5>üìã Riwayat Absensi</h5>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>File</th>
            <th>Tanggal</th>
            <th>Jam Datang</th>
            <th>Jenis</th>
            <th>Status</th>
            <th>Keterangan</th>
          </tr>
        </thead>
        <tbody>
          {% for r in uploads %}
            <tr>
              <td><a href="/uploads/{{ r['filename'] }}" target="_blank">{{ r['filename'][:30] }}...</a></td>
              <td>{{ r['tanggal'] }}</td>
              <td>{{ r['jam_datang'] or '-' }}</td>
              <td>
                {% if r['jenis'] == 'izin' %}
                  <span class="badge badge-izin">Izin</span>
                {% else %}
                  <span class="badge badge-hadir">Hadir</span>
                {% endif %}
              </td>
              <td>
                {% if r['status'] == 'Disetujui' %}
                  <span class="badge bg-success">Disetujui</span>
                {% elif r['status'] == 'Pending' %}
                  <span class="badge bg-warning">Pending</span>
                {% else %}
                  <span class="badge bg-danger">Ditolak</span>
                {% endif %}
              </td>
              <td>
                {% if r['jenis'] == 'izin' and r['keterangan_izin'] %}
                  <strong>Izin:</strong> {{ r['keterangan_izin'][:50] }}{% if r['keterangan_izin']|length > 50 %}...{% endif %}
                  <br><small style="color:#666;">{{ r['alasan'] }}</small>
                {% else %}
                  {{ r['alasan'] }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
</body>
</html>
