<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload - Absensi Piket</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: #fef9e7;
      font-family: 'Roboto', sans-serif;
      background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 31px, #e8dcc4 31px, #e8dcc4 32px),
        repeating-linear-gradient(90deg, transparent, transparent 31px, #e8dcc4 31px, #e8dcc4 32px);
      min-height: 100vh;
    }
    
    nav {
      background: white;
      border-bottom: 3px solid #333;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .navbar-brand {
      font-size: clamp(18px, 4vw, 24px);
      color: #e74c3c;
      font-weight: bold;
    }
    
    .btn {
      font-family: 'Roboto', sans-serif;
      padding: 8px 20px;
      border: 3px solid #333;
      background: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.2s;
      text-decoration: none;
      color: #333;
      display: inline-block;
    }
    
    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 3px 3px 0 #333;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-outline-secondary {
      background: #ecf0f1;
    }
    
    .btn-success {
      background: #2ecc71;
      color: white;
    }
    
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 15px;
    }
    
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 3px solid #333;
      background: #fff9c4;
      font-size: 16px;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
      border-radius: 5px;
    }
    
    .alert-success {
      background: #d4edda;
      border-color: #2ecc71;
    }
    
    .alert-danger {
      background: #f8d7da;
      border-color: #e74c3c;
    }
    
    .alert-info {
      background: #d1ecf1;
      border-color: #3498db;
    }
    
    .card {
      background: white;
      border: 3px solid #333;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    
    h5 {
      font-size: clamp(20px, 4vw, 26px);
      color: #e74c3c;
      margin-bottom: 20px;
      font-weight: bold;
    }
    
    .upload-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      flex: 1;
      min-width: 140px;
      padding: 12px 20px;
      border: 3px solid #333;
      background: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .tab-btn.active {
      background: #3498db;
      color: white;
    }
    
    .tab-btn:hover {
      transform: translateY(-2px);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-control, .form-textarea {
      padding: 12px;
      border: 3px solid #333;
      background: white;
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-control:focus, .form-textarea:focus {
      outline: none;
      background: #fffacd;
      border-color: #3498db;
    }
    
    .upload-info {
      padding: 10px;
      background: #e8f4f8;
      border-left: 4px solid #3498db;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .char-count {
      font-size: 12px;
      color: #666;
      text-align: right;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }
    
    th {
      background: #3498db;
      color: white;
      padding: 12px 8px;
      text-align: left;
      border: 2px solid #333;
      font-weight: bold;
    }
    
    td {
      padding: 10px 8px;
      border: 2px solid #ddd;
      background: white;
      word-break: break-word;
    }
    
    tr:nth-child(even) td {
      background: #f8f9fa;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 10px;
      border: 2px solid #333;
      font-weight: bold;
      font-size: 12px;
      border-radius: 4px;
      white-space: nowrap;
    }
    
    .badge-hadir {
      background: #17a2b8;
      color: white;
    }
    
    .badge-izin {
      background: #ffc107;
      color: #333;
    }
    
    .bg-success {
      background: #2ecc71;
      color: white;
    }
    
    .bg-warning {
      background: #f39c12;
      color: #333;
    }
    
    .bg-danger {
      background: #e74c3c;
      color: white;
    }
    
    a {
      color: #3498db;
      word-break: break-all;
    }
    
    a:hover {
      color: #e74c3c;
    }
    
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .submit-btn-container {
      margin-top: 15px;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      nav {
        padding: 10px 15px;
      }
      
      .container {
        padding: 0 10px;
      }
      
      .card {
        padding: 15px;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 4px;
      }
      
      .btn {
        padding: 8px 15px;
        font-size: 14px;
      }
      
      .tab-btn {
        min-width: 120px;
        padding: 10px 15px;
        font-size: 14px;
      }
      
      th:nth-child(1), td:nth-child(1) {
        min-width: 150px;
      }
    }
    
    @media (max-width: 480px) {
      .navbar-brand {
        font-size: 16px;
      }
      
      h5 {
        font-size: 18px;
      }
      
      table {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
<nav>
  <span class="navbar-brand">üëã Halo, {{ username }}</span>
  <div>
    <a class="btn btn-outline-secondary" href="/logout">Logout</a>
  </div>
</nav>

<div class="container">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card">
    <h5>üì∏ Upload Absensi</h5>
    
    <div class="upload-info">
      üìä Upload hari ini: <strong>{{ upload_count }}/{{ max_upload }}</strong> | 
      Sisa: <strong>{{ remaining }}</strong> kali
    </div>
    
    <div class="upload-tabs">
      <button class="tab-btn active" onclick="switchTab('hadir')">‚úÖ Hadir</button>
      <button class="tab-btn" onclick="switchTab('izin')">üìù Izin</button>
    </div>
    
    <!-- Tab Hadir -->
    <div id="tab-hadir" class="tab-content active">
      <form method="post" action="/upload" enctype="multipart/form-data">
        <input type="hidden" name="jenis" value="hadir">
        
        <div class="form-group">
          <label>üì∑ Pilih Foto</label>
          <input class="form-control" type="file" name="file" accept="image/*" required 
                 {% if remaining <= 0 %}disabled{% endif %}>
          <small style="color: #666; font-size: 12px;">
            ‚ÑπÔ∏è Foto harus diambil jam 06:00-06:59 atau di lokasi sekolah
          </small>
        </div>
        
        <div class="submit-btn-container">
          <button class="btn btn-success" type="submit" style="width: 100%;"
                  {% if remaining <= 0 %}disabled{% endif %}>
            Upload Absensi Hadir
          </button>
        </div>
      </form>
    </div>
    
    <!-- Tab Izin -->
    <div id="tab-izin" class="tab-content">
      <form method="post" action="/upload" enctype="multipart/form-data">
        <input type="hidden" name="jenis" value="izin">
        
        <div class="form-group">
          <label>üì∑ Upload Bukti (Surat Dokter/Foto)</label>
          <input class="form-control" type="file" name="file" accept="image/*" required
                 {% if remaining <= 0 %}disabled{% endif %}>
        </div>
        
        <div class="form-group">
          <label>üìù Keterangan Izin *</label>
          <textarea class="form-textarea" name="keterangan_izin" 
                    placeholder="Contoh: Sakit demam, ada surat dokter..." 
                    required minlength="10" maxlength="500"
                    oninput="updateCharCount(this)"
                    {% if remaining <= 0 %}disabled{% endif %}></textarea>
          <div class="char-count" id="charCount">0/500 karakter (minimal 10)</div>
        </div>
        
        <div class="submit-btn-container">
          <button class="btn btn-success" type="submit" style="width: 100%;"
                  {% if remaining <= 0 %}disabled{% endif %}>
            Kirim Pengajuan Izin
          </button>
        </div>
      </form>
    </div>
    
    <p style="margin-top: 15px; font-size: 13px; color: #666; text-align: center;">
      ‚ÑπÔ∏è File: JPG, PNG, GIF, BMP, WEBP (Max 10MB)
    </p>
  </div>

  <div class="card">
    <h5>üìã Riwayat Absensi</h5>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>File</th>
            <th>Tanggal</th>
            <th>Jenis</th>
            <th>Status</th>
            <th>Keterangan</th>
          </tr>
        </thead>
        <tbody>
          {% for r in uploads %}
            <tr>
              <td>
                <a href="/uploads/{{ r['filename'] }}" target="_blank">
                  {{ r['filename'][:30] }}...
                </a>
              </td>
              <td>{{ r['tanggal'] }}</td>
              <td>
                {% if r['jenis'] == 'izin' %}
                  <span class="badge badge-izin">Izin</span>
                {% else %}
                  <span class="badge badge-hadir">Hadir</span>
                {% endif %}
              </td>
              <td>
                {% if r['status'] == 'Disetujui' %}
                  <span class="badge bg-success">Disetujui</span>
                {% elif r['status'] == 'Pending' %}
                  <span class="badge bg-warning">Pending</span>
                {% else %}
                  <span class="badge bg-danger">Ditolak</span>
                {% endif %}
              </td>
              <td>
                {% if r['jenis'] == 'izin' and r['keterangan_izin'] %}
                  <strong>Izin:</strong> {{ r['keterangan_izin'][:50] }}
                  {% if r['keterangan_izin']|length > 50 %}...{% endif %}
                  <br><small style="color: #666;">{{ r['alasan'] }}</small>
                {% else %}
                  {{ r['alasan'] }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
function switchTab(tab) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  
  // Show selected tab
  document.getElementById('tab-' + tab).classList.add('active');
  event.target.classList.add('active');
}

function updateCharCount(textarea) {
  const count = textarea.value.length;
  const counter = document.getElementById('charCount');
  counter.textContent = `${count}/500 karakter ${count < 10 ? '(minimal 10)' : ''}`;
  counter.style.color = count < 10 ? '#e74c3c' : count > 450 ? '#f39c12' : '#666';
}
</script>
</body>
</html>